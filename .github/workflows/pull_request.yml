on: pull_request
name: Check PR
jobs:
  check_pr:
    name: Check PR
    runs-on: ubuntu-latest
    steps:
    - name: Setup Go Env
      uses: actions/setup-go@v1
      with:
        go-version: 1.13
    - name: checkout code
      uses: actions/checkout@master
    - name: fetch deps
      run: go get
    - name: Go Vet
      run: go vet ./...
    - name: Go Format Check
      run: |
          if [[ ! -z "$(gofmt -s -l . | grep -v vendor | tee /dev/stderr)" ]]; then
            exit 1;
          fi
    - name: Run Tests
      run: go test ./...
    - name: Build Image
      uses: actions/docker/cli@76ff57a
      with:
        args: build -t tmp .
  test_build_and_publish_binary:
    name: Build and Publish Binary
    runs-on: ubuntu-latest
    steps:
    - name: Setup Go Env
      uses: actions/setup-go@v1
      with:
        go-version: 1.13
    - name: checkout code
      uses: actions/checkout@master
    - name: install gox
      run: go get github.com/mitchellh/gox
    - name: install ghr
      run: go get -u github.com/tcnksm/ghr
    - name: compile
      run: make dist
    - name: publish
      run: make publish
  test_build_and_publish_docker_image:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@master
    - name: '[Dockerhub] Docker Login'
      uses: actions/docker/login@master
      env:
        DOCKER_PASSWORD: '${{ secrets.DOCKER_PASSWORD }}'
        DOCKER_USERNAME: '${{ secrets.DOCKER_USERNAME }}'
    - name: '[Github] Docker Login'
      uses: actions/docker/login@master
      env:
        DOCKER_PASSWORD: '${{ secrets.GH_DOCKER_PASSWORD }}'
        DOCKER_USERNAME: $GITHUB_ACTOR
        DOCKER_REGISTRY_URL: docker.pkg.github.com
    - name: Build kube-gen Image
      uses: actions/docker/cli@master
      with:
        args: build -t app .
    - name: '[Dockerhub] Tag Image'
      uses: actions/docker/tag@master
      with:
        args: --env app kylemcc/kube-gen
    - name: '[Github] Tag Image'
      uses: actions/docker/tag@master
      with:
        args: --env app docker.pkg.github.com/kylemcc/kube-gen/kube-gen
    - name: '[Dockerhub] Push Image'
      uses: actions/docker/cli@76ff57a
      with:
        args: push kylemcc/kube-gen
    - name: '[Github] Push Image'
      uses: actions/docker/cli@76ff57a
      with:
        args: push docker.pkg.github.com/kylemcc/kube-gen/kube-gen
    - name: Send Slack Notification
      uses: kylemcc/actions/slack-webhook@master
      if: always()
      env:
        SLACK_MESSAGE: '$GITHUB_REPOSITORY: Build ${{ job.status }}'
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
